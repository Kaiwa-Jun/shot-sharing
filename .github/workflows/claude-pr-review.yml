name: Claude PR Review

on:
  # PR作成時・更新時に自動レビューを実行
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

  # PRやIssueへのコメントで@claudeメンションがあった場合に実行
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write  # OIDC認証に必要
  actions: read    # CI結果の分析に必要

jobs:
  # PR自動レビュー（PR作成・更新時）
  auto-review:
    if: |
      github.event_name == 'pull_request' &&
      !github.event.pull_request.draft
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 全履歴を取得してdiffを正確に分析

      - name: Run Claude Code Review
        uses: anthropics/claude-code-base-action@beta
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        with:
          prompt: |
            PR #${{ github.event.pull_request.number }}をレビューして、結果を以下のコマンドでコメントしてください：

            gh pr comment ${{ github.event.pull_request.number }} --body "レビュー内容"

            簡潔にレビューしてください。

          allowed_tools: "Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Read,View,GlobTool,GrepTool"
          model: "claude-3-5-sonnet-20241022"

  # @claudeメンションへの応答
  mention-response:
    if: |
      github.event_name == 'issue_comment' &&
      (contains(github.event.comment.body, '@claude') ||
       contains(github.event.comment.body, '@Claude'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Respond to Claude mention
        uses: anthropics/claude-code-base-action@beta
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        with:
          prompt: |
            @${{ github.event.comment.user.login }} さんのコメント「${{ github.event.comment.body }}」に応答して、
            結果を以下のコマンドでコメントしてください：

            gh pr comment ${{ github.event.issue.number }} --body "応答内容"

          allowed_tools: "Bash(gh issue comment:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Read,View,GlobTool,GrepTool"
          model: "claude-3-5-sonnet-20241022"

  # レビュー失敗時の通知（オプション）
  notify-failure:
    if: failure()
    needs: [auto-review, mention-response]
    runs-on: ubuntu-latest
    steps:
      - name: Post failure comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // contextはgithub-scriptが自動的に提供するため、宣言不要
            const issue_number = context.payload.pull_request?.number || context.payload.issue?.number;

            if (issue_number) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue_number,
                body: '⚠️ Claude Codeによるレビューの実行に失敗しました。ワークフローのログを確認してください。'
              });
            }
