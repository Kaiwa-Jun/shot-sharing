name: Claude PR Review

on:
  # PR作成時・更新時に自動レビューを実行
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

  # PRやIssueへのコメントで@claudeメンションがあった場合に実行
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write
  actions: read

jobs:
  # PR自動レビュー（PR作成・更新時）
  auto-review:
    if: |
      github.event_name == 'pull_request' &&
      !github.event.pull_request.draft
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Review
        uses: anthropics/claude-code-base-action@beta
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          prompt: |
            このPRを詳細にレビューし、レビュー結果をGitHubのPRコメントとして投稿してください。
            必ず`gh pr comment ${{ github.event.pull_request.number }} --body "レビュー内容"`の形式でコマンドを使用してフィードバックをPRに投稿してください。

            ## レビュー方針
            - セキュリティ: SQLインジェクション、XSS、CSRF、認証・認可、機密情報漏洩
            - コード品質: 可読性、保守性、設計パターン、命名規則、エラーハンドリング
            - パフォーマンス: N+1問題、不必要な計算、メモリリーク、キャッシュ
            - ベストプラクティス: コーディング規約、テストカバレッジ、ドキュメント、型安全性

            ultrathink
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_tools: "Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Read,View,GlobTool,GrepTool"
          model: "claude-3-5-sonnet-20241022"

  # @claudeメンションへの応答
  mention-response:
    if: |
      github.event_name == 'issue_comment' &&
      (contains(github.event.comment.body, '@claude') || contains(github.event.comment.body, '@Claude'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Respond to Claude mention
        uses: anthropics/claude-code-base-action@beta
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          prompt: |
            ユーザーのコメント: ${{ github.event.comment.body }}

            ユーザーのコメントに対して適切に応答し、その応答を`gh issue comment ${{ github.event.issue.number }} --body "コメント内容"`または`gh pr comment ${{ github.event.issue.number }} --body "コメント内容"`を使用してGitHubに投稿してください。

            ultrathink
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_tools: "Bash(gh issue comment:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Read,View,GlobTool,GrepTool"
          model: "claude-3-5-sonnet-20241022"
