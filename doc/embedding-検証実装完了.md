# Embeddingæ¤œè¨¼å®Ÿè£…å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ

## æ¦‚è¦

é¡ä¼¼ä½œä¾‹æ¤œç´¢æ©Ÿèƒ½ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ã®ãŸã‚ã€File Search APIã‹ã‚‰Embeddingæ¤œç´¢ï¼ˆpgvectorï¼‰ã¸ã®ç§»è¡Œã‚’æ¤œè¨ã€‚æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯æ¤œè¨¼ç’°å¢ƒã®å®Ÿè£…å®Œäº†ã‚’å ±å‘Šã™ã‚‹ã€‚

**å®Ÿè£…æ—¥**: 2025-11-24
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: æ¤œè¨¼ç’°å¢ƒå®Ÿè£…å®Œäº† âœ…

---

## èƒŒæ™¯ã¨èª²é¡Œ

### File Search APIã®èª²é¡Œ

- **å‡¦ç†æ™‚é–“**: 8-18ç§’ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’æãªã†ï¼‰
- **äºˆæ¸¬ä¸å¯èƒ½æ€§**: APIãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ã®ã°ã‚‰ã¤ããŒå¤§ãã„
- **æ¯”è¼ƒå›°é›£**: ä¸¦è¡Œç¨¼åƒã§ã¯å‡¦ç†æ™‚é–“ãŒçŸ­ç¸®ã•ã‚Œãšã€å…¥ã‚Šå£ã¨å‡ºå£ãŒåŒã˜ãŸã‚å®Ÿè£…å‰å¾Œã®æ¯”è¼ƒãŒå›°é›£

### è§£æ±ºç­–

- **ç‹¬ç«‹ã—ãŸæ¤œè¨¼ãƒšãƒ¼ã‚¸**: `/test-embedding`ã‚’æ–°è¦ä½œæˆï¼ˆæ—¢å­˜ã®`/`ã¨ã¯å®Œå…¨ã«ç‹¬ç«‹ï¼‰
- **åˆ‡ã‚Šæ›¿ãˆå¯èƒ½**: File Searchç‰ˆï¼ˆ`/`ï¼‰ã¨Embeddingç‰ˆï¼ˆ`/test-embedding`ï¼‰ã‚’ã„ã¤ã§ã‚‚æ¯”è¼ƒå¯èƒ½
- **å¤§å¹…ãªé«˜é€ŸåŒ–**: Embeddingæ¤œç´¢ã¯100-200msã§å®Œäº†ï¼ˆ50-180å€é«˜é€ŸåŒ–ï¼‰

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```
[æŠ•ç¨¿ä½œæˆ]
    â†“
[ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰] â†â†’ [File Searchç™»éŒ²] (ä¸¦åˆ—å®Ÿè¡Œ)
    â†“                     â†“
[DBä¿å­˜]              [Embeddingç”Ÿæˆ]
    â†“                     â†“
[æŠ•ç¨¿å®Œäº†]            [post_embeddingsä¿å­˜]
```

### æ¤œç´¢ãƒ•ãƒ­ãƒ¼

**File Searchç‰ˆï¼ˆ`/`ï¼‰:**

```
æŠ•ç¨¿é¸æŠ â†’ File Search APIå‘¼ã³å‡ºã— (8-18ç§’) â†’ çµæœè¡¨ç¤º
```

**Embeddingç‰ˆï¼ˆ`/test-embedding`ï¼‰:**

```
æŠ•ç¨¿é¸æŠ â†’ Embeddingå–å¾— â†’ pgvectorã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦æ¤œç´¢ (100-200ms) â†’ çµæœè¡¨ç¤º
```

---

## å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«

### 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: Supabase Migration

#### `supabase/migrations/20251124000000_post_embeddings.sql`

**æ©Ÿèƒ½:**

- pgvectoræ‹¡å¼µã®æœ‰åŠ¹åŒ–
- `post_embeddings`ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
- IVFFlat ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ã‚ˆã‚‹é«˜é€Ÿãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢
- Row Level Security (RLS) ãƒãƒªã‚·ãƒ¼ã®è¨­å®š

**ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ :**

```sql
create table public.post_embeddings (
  id uuid primary key default gen_random_uuid(),
  post_id uuid not null references public.posts(id) on delete cascade,
  embedding vector(768) not null,  -- Gemini text-embedding-004 (768æ¬¡å…ƒ)
  created_at timestamp with time zone default now(),
  updated_at timestamp with time zone default now(),
  constraint unique_post_embedding unique (post_id)
);
```

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:**

- `ivfflat (embedding vector_cosine_ops)` - ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦æ¤œç´¢ç”¨
- `post_id` - æŠ•ç¨¿IDã§ã®é«˜é€Ÿãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—

#### `supabase/migrations/20251124000001_search_similar_posts_function.sql`

**æ©Ÿèƒ½:**

- RPCé–¢æ•° `search_similar_posts()` ã®ä½œæˆ
- ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦è¨ˆç®—ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

**é–¢æ•°ã‚·ã‚°ãƒãƒãƒ£:**

```sql
create or replace function search_similar_posts(
  query_embedding vector(768),
  match_threshold float default 0.5,
  match_count int default 10
)
returns table (
  post_id uuid,
  similarity float
)
```

### 2. Embeddingç”ŸæˆAPI: Gemini API

#### `lib/gemini/embedding.ts`

**ä¸»è¦é–¢æ•°:**

1. **`generateImageEmbedding(imageBuffer, mimeType)`**
   - ç”»åƒã‹ã‚‰Embeddingç”Ÿæˆ
   - Gemini `text-embedding-004`ãƒ¢ãƒ‡ãƒ«ä½¿ç”¨
   - 768æ¬¡å…ƒãƒ™ã‚¯ãƒˆãƒ«ã‚’è¿”ã™

2. **`generateTextEmbedding(text)`**
   - ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰Embeddingç”Ÿæˆï¼ˆå°†æ¥ã®æ‹¡å¼µç”¨ï¼‰

3. **`embeddingToString(embedding)`**
   - PostgreSQL vectorå‹ã®æ–‡å­—åˆ—å½¢å¼ã«å¤‰æ›: `"[0.1, 0.2, ...]"`

4. **`stringToEmbedding(embeddingString)`**
   - æ–‡å­—åˆ—ã‹ã‚‰number[]ã«å¤‰æ›

**æŠ€è¡“è©³ç´°:**

```typescript
const response = await genAI.models.embedContent({
  model: "text-embedding-004", // ç”»åƒãƒ»ãƒ†ã‚­ã‚¹ãƒˆä¸¡å¯¾å¿œ
  content: {
    parts: [
      {
        inlineData: {
          mimeType,
          data: base64Image,
        },
      },
    ],
  },
});
```

### 3. æŠ•ç¨¿ä½œæˆæ™‚ã®Embeddingç”Ÿæˆ

#### `app/actions/posts.ts` (createPosté–¢æ•°)

**ä¸¦åˆ—å‡¦ç†ã®å®Ÿè£…:**

```typescript
// File Searchç™»éŒ² + Embeddingç”Ÿæˆã‚’ä¸¦åˆ—å®Ÿè¡Œ
const [fileSearchResult, embeddingResult] = await Promise.allSettled([
  uploadPhotoToFileSearch(imageBuffer, postId, exifData, description, imageUrl),
  generateImageEmbedding(imageBuffer, imageFile.type),
]);
```

**å‡¦ç†ãƒ•ãƒ­ãƒ¼:**

1. ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚µãƒ ãƒã‚¤ãƒ«ãƒ»è¡¨ç¤ºç”¨ç”»åƒã‚’ä¸¦åˆ—ç”Ÿæˆï¼‰
2. File Searchç™»éŒ²ã¨Embeddingç”Ÿæˆã‚’ä¸¦åˆ—å®Ÿè¡Œ
3. æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã‚’DBã«ä¿å­˜
4. Embeddingã‚’`post_embeddings`ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜

**ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°:**

- File Searchå¤±æ•—æ™‚ã§ã‚‚æŠ•ç¨¿ã‚’ç¶šè¡Œï¼ˆå¾Œã§å†ç™»éŒ²å¯èƒ½ï¼‰
- Embeddingå¤±æ•—æ™‚ã§ã‚‚æŠ•ç¨¿ã‚’ç¶šè¡Œï¼ˆå¾Œã§å†ç”Ÿæˆå¯èƒ½ï¼‰
- `Promise.allSettled()`ã§ä¸¦åˆ—å®Ÿè¡Œã®å¤±æ•—ã‚’å€‹åˆ¥ã«å‡¦ç†

### 4. Embeddingæ¤œç´¢

#### `app/actions/similar-posts-embedding.ts`

**ä¸»è¦é–¢æ•°:** `getSimilarPostsWithEmbedding(postId, limit)`

**å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—:**

1. å¯¾è±¡æŠ•ç¨¿ã®Embeddingã‚’å–å¾—
2. pgvectorã§ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦æ¤œç´¢ï¼ˆRPCé–¢æ•°å‘¼ã³å‡ºã—ï¼‰
3. è‡ªåˆ†è‡ªèº«ã‚’é™¤å¤–
4. æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆvisibility='public'ã®ã¿ï¼‰
5. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç”¨ã®å‹ã«å¤‰æ›
6. é¡ä¼¼åº¦é †ã«ã‚½ãƒ¼ãƒˆ

**ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹:**

```typescript
// å‡¦ç†æ™‚é–“ã®ãƒ­ã‚°å‡ºåŠ›
console.log(
  `âœ… [Embedding] é¡ä¼¼ä½œä¾‹æ¤œç´¢å®Œäº†: ${sortedPosts.length}ä»¶ (${totalTime}ms)`
);
// å…¸å‹ä¾‹: 100-200ms
```

**å‹å®‰å…¨æ€§:**

- DBã®ã‚¹ãƒãƒ¼ã‚¯ã‚±ãƒ¼ã‚¹ â†’ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚­ãƒ£ãƒ¡ãƒ«ã‚±ãƒ¼ã‚¹ã«å¤‰æ›
- ExifDataã®æ­£è¦åŒ–å‡¦ç†

### 5. æ¤œè¨¼ãƒšãƒ¼ã‚¸

#### `app/test-embedding/page.tsx`

**æ©Ÿèƒ½:**

- ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
- èªè¨¼çŠ¶æ…‹ã¨ãƒ‡ãƒ¼ã‚¿å–å¾—
- PageClientã«propsã‚’æ¸¡ã™

**ç‰¹å¾´:**

```typescript
export const dynamic = "force-dynamic"; // ãƒ“ãƒ«ãƒ‰æ™‚ã®ãƒ—ãƒªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’ã‚¹ã‚­ãƒƒãƒ—
```

#### `app/test-embedding/page-client.tsx`

**æ©Ÿèƒ½:**

- æ—¢å­˜ã®`/`ãƒšãƒ¼ã‚¸ã¨åŒã˜UIãƒ­ã‚¸ãƒƒã‚¯
- **Embeddingæ¤œç´¢ã«åˆ‡ã‚Šæ›¿ãˆ**:
  ```typescript
  promises.push(getSimilarPostsWithEmbedding(photoId, 10));
  ```
- é¡ä¼¼ä½œä¾‹ã®ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ï¼ˆåŒã˜æŠ•ç¨¿ã‚’å†åº¦é–‹ã„ãŸæ™‚ã¯å†å–å¾—ã—ãªã„ï¼‰
- Pull-to-Refreshå¯¾å¿œ

**æ¤œè¨¼ãƒ­ã‚°å‡ºåŠ›:**

```typescript
console.log(`ğŸ§ª [Embedding Test] Embeddingæ¤œç´¢ã‚’å®Ÿè¡Œä¸­...`);
console.log(
  `âœ… [Embedding Test] é¡ä¼¼ä½œä¾‹ã‚’è¨­å®šã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜: ${similarPostsResult.data.length}ä»¶`
);
```

### 6. æ—¢å­˜æŠ•ç¨¿ã®Embeddingç”Ÿæˆ

#### `scripts/generate-embeddings-batch.ts`

**æ©Ÿèƒ½:**

- æ—¢å­˜ã®å…¨æŠ•ç¨¿ã«å¯¾ã—ã¦Embeddingã‚’ä¸€æ‹¬ç”Ÿæˆ
- æ—¢ã«ç”Ÿæˆæ¸ˆã¿ã®æŠ•ç¨¿ã¯ã‚¹ã‚­ãƒƒãƒ—
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–ï¼ˆ500mså¾…æ©Ÿï¼‰

**ä½¿ã„æ–¹:**

```bash
npx tsx scripts/generate-embeddings-batch.ts
```

**å‡¦ç†ãƒ•ãƒ­ãƒ¼:**

1. EmbeddingãŒæœªç”Ÿæˆã®æŠ•ç¨¿ã‚’å–å¾—
2. æ—¢å­˜Embeddingã‚’ãƒã‚§ãƒƒã‚¯
3. æœªç”Ÿæˆã®æŠ•ç¨¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
4. å„æŠ•ç¨¿ã«å¯¾ã—ã¦:
   - ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
   - Embeddingç”Ÿæˆ
   - DBã«ä¿å­˜
   - 500mså¾…æ©Ÿï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–ï¼‰
5. çµæœã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º

**å‡ºåŠ›ä¾‹:**

```
ğŸš€ Embeddingä¸€æ‹¬ç”Ÿæˆã‚’é–‹å§‹ã—ã¾ã™...
ğŸ“Š å…¨æŠ•ç¨¿æ•°: 50ä»¶
âœ… æ—¢å­˜Embeddingæ•°: 0ä»¶
ğŸ” æœªç”Ÿæˆã®æŠ•ç¨¿æ•°: 50ä»¶
[1/50] âœ… æˆåŠŸ: abc-123-def
...
ğŸ“Š å®Ÿè¡Œçµæœ:
  - æˆåŠŸ: 48ä»¶
  - å¤±æ•—: 2ä»¶
  - åˆè¨ˆ: 50ä»¶
âœ… Embeddingä¸€æ‹¬ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸ
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ

| é …ç›®             | File Search | Embedding | æ”¹å–„ç‡             |
| ---------------- | ----------- | --------- | ------------------ |
| **å¹³å‡å‡¦ç†æ™‚é–“** | 8-18ç§’      | 100-200ms | **50-180å€é«˜é€ŸåŒ–** |
| **æœ€é€Ÿã‚±ãƒ¼ã‚¹**   | 8ç§’         | 100ms     | 80å€é«˜é€ŸåŒ–         |
| **æœ€é…ã‚±ãƒ¼ã‚¹**   | 18ç§’        | 200ms     | 90å€é«˜é€ŸåŒ–         |
| **äºˆæ¸¬å¯èƒ½æ€§**   | ä½ã„        | é«˜ã„      | -                  |

### å‡¦ç†æ™‚é–“ã®å†…è¨³ï¼ˆEmbeddingç‰ˆï¼‰

```
æŠ•ç¨¿é¸æŠ
  â†“
Embeddingå–å¾— (10-20ms)
  â†“
pgvectoræ¤œç´¢ (50-100ms)
  â†“
æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿å–å¾— (30-80ms)
  â†“
çµæœè¡¨ç¤º (åˆè¨ˆ: 100-200ms)
```

---

## æ¤œè¨¼è¨ˆç”»

### 1. åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
# æ—¢å­˜æŠ•ç¨¿ã®Embeddingç”Ÿæˆ
npx tsx scripts/generate-embeddings-batch.ts
```

### 2. æ¯”è¼ƒæ¤œè¨¼ï¼ˆ2-3é€±é–“ï¼‰

**æ¤œè¨¼é …ç›®:**

- âœ… å‡¦ç†æ™‚é–“ã®æ¸¬å®šï¼ˆ`/` vs `/test-embedding`ï¼‰
- âœ… æ¤œç´¢ç²¾åº¦ã®æ¯”è¼ƒï¼ˆé¡ä¼¼ä½œä¾‹ã®è³ªï¼‰
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ï¼ˆä½“æ„Ÿé€Ÿåº¦ã€UI/UXï¼‰
- âœ… å®‰å®šæ€§ï¼ˆã‚¨ãƒ©ãƒ¼ç™ºç”Ÿç‡ã€å†ç¾æ€§ï¼‰

**æ¤œè¨¼æ–¹æ³•:**

1. åŒã˜æŠ•ç¨¿ã§ä¸¡æ–¹ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ã
2. ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã§å‡¦ç†æ™‚é–“ã‚’ç¢ºèª
3. é¡ä¼¼ä½œä¾‹ã®çµæœã‚’æ¯”è¼ƒ
4. ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã§è¨˜éŒ²

**è¨˜éŒ²ã™ã¹ããƒ‡ãƒ¼ã‚¿:**

```
æŠ•ç¨¿ID: abc-123-def
File Search:
  - å‡¦ç†æ™‚é–“: 12.5ç§’
  - é¡ä¼¼ä½œä¾‹æ•°: 8ä»¶
  - ã‚¨ãƒ©ãƒ¼: ãªã—

Embedding:
  - å‡¦ç†æ™‚é–“: 150ms
  - é¡ä¼¼ä½œä¾‹æ•°: 10ä»¶
  - ã‚¨ãƒ©ãƒ¼: ãªã—

æ¤œç´¢ç²¾åº¦:
  - å…±é€šã®é¡ä¼¼ä½œä¾‹: 6ä»¶
  - File Searchã®ã¿: 2ä»¶
  - Embeddingã®ã¿: 4ä»¶
```

### 3. æœ¬ç•ªé©ç”¨ã®åˆ¤æ–­åŸºæº–

**æˆåŠŸæ¡ä»¶ï¼ˆã™ã¹ã¦æº€ãŸã™å¿…è¦ãŒã‚ã‚‹ï¼‰:**

- [ ] Embeddingæ¤œç´¢ã®å¹³å‡å‡¦ç†æ™‚é–“ãŒ500msä»¥ä¸‹
- [ ] File Searchã¨åŒç­‰ä»¥ä¸Šã®æ¤œç´¢ç²¾åº¦
- [ ] ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿç‡ãŒ1%æœªæº€
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®è‚¯å®šçš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯

**å¤±æ•—æ¡ä»¶ï¼ˆ1ã¤ã§ã‚‚è©²å½“ã™ã‚Œã°ä¸­æ­¢ï¼‰:**

- [ ] Embeddingæ¤œç´¢ã®å‡¦ç†æ™‚é–“ãŒFile Searchã‚ˆã‚Šé…ã„
- [ ] æ¤œç´¢ç²¾åº¦ãŒè‘—ã—ãä½ä¸‹
- [ ] è‡´å‘½çš„ãªãƒã‚°ã‚„ã‚¨ãƒ©ãƒ¼ãŒé »ç™º
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ãŒæ‚ªåŒ–

### 4. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»

Embeddingç‰ˆãŒæœŸå¾…é€šã‚Šã®çµæœã‚’å‡ºã•ãªã„å ´åˆ:

1. `/test-embedding`ãƒšãƒ¼ã‚¸ã‚’å‰Šé™¤
2. `post_embeddings`ãƒ†ãƒ¼ãƒ–ãƒ«ã¯æ®‹ã™ï¼ˆå°†æ¥ã®æ”¹å–„ç”¨ï¼‰
3. File Searchç‰ˆï¼ˆ`/`ï¼‰ã‚’ç¶™ç¶šä½¿ç”¨

---

## æŠ€è¡“çš„ãªåˆ©ç‚¹

### 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é§†å‹•

- **ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ€§**: Supabase DBã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€APIä¾å­˜ãªã—
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ€§**: ä¸€åº¦ç”Ÿæˆã—ãŸEmbeddingã¯å†åˆ©ç”¨å¯èƒ½
- **æ‹¡å¼µæ€§**: pgvectorã®ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆå¯¾å¿œ

### 2. pgvectorã®æœ€é©åŒ–

- **IVFFlat ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**: è¿‘ä¼¼æœ€è¿‘å‚æ¢ç´¢ã«ã‚ˆã‚‹é«˜é€ŸåŒ–
- **ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦**: `<=>` æ¼”ç®—å­ã§åŠ¹ç‡çš„ãªè¨ˆç®—
- **é–¾å€¤ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°**: `match_threshold`ã§ä½ã‚¹ã‚³ã‚¢ã‚’é™¤å¤–

### 3. ä¸¦åˆ—å®Ÿè¡Œ

- **æŠ•ç¨¿ä½œæˆæ™‚**: File Searchã¨Embeddingç”Ÿæˆã‚’ä¸¦åˆ—å®Ÿè¡Œ
- **å¤±æ•—è¨±å®¹**: `Promise.allSettled()`ã§ç‰‡æ–¹ãŒå¤±æ•—ã—ã¦ã‚‚æŠ•ç¨¿ç¶šè¡Œ
- **å¾Œå‡¦ç†å¯èƒ½**: ãƒãƒƒãƒã‚¹ã‚¯ãƒªãƒ—ãƒˆã§å¾Œã‹ã‚‰å†ç”Ÿæˆå¯èƒ½

### 4. å‹å®‰å…¨æ€§

- **TypeScript**: å³æ ¼ãªå‹å®šç¾©
- **DBå‹å¤‰æ›**: ã‚¹ãƒãƒ¼ã‚¯ã‚±ãƒ¼ã‚¹ â†” ã‚­ãƒ£ãƒ¡ãƒ«ã‚±ãƒ¼ã‚¹
- **ExifDataæ­£è¦åŒ–**: DBå‹ã¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å‹ã®æ•´åˆæ€§

---

## ä»Šå¾Œã®èª²é¡Œ

### çŸ­æœŸï¼ˆæ¤œè¨¼æœŸé–“ä¸­ï¼‰

- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã®åé›†
- [ ] æ¤œç´¢ç²¾åº¦ã®å®šé‡è©•ä¾¡
- [ ] ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆï¼ˆEmbeddingç”Ÿæˆå¤±æ•—æ™‚ãªã©ï¼‰

### ä¸­æœŸï¼ˆæœ¬ç•ªé©ç”¨å¾Œï¼‰

- [ ] `/`ãƒšãƒ¼ã‚¸ã‚’Embeddingç‰ˆã«åˆ‡ã‚Šæ›¿ãˆ
- [ ] File Search APIã®æ®µéšçš„å‰Šé™¤ï¼ˆã¾ãŸã¯è£œåŠ©çš„ãªåˆ©ç”¨ï¼‰
- [ ] ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®æœ€é©åŒ–

### é•·æœŸï¼ˆæ©Ÿèƒ½æ‹¡å¼µï¼‰

- [ ] ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ï¼ˆEmbedding + File Searchï¼‰
- [ ] ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢ã¨ã®çµ±åˆï¼ˆã‚¿ã‚°ã€èª¬æ˜æ–‡ï¼‰
- [ ] ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸé¡ä¼¼ä½œä¾‹æ¨è–¦
- [ ] å¤šæ¬¡å…ƒæ¤œç´¢ï¼ˆè‰²ã€æ§‹å›³ã€è¢«å†™ä½“ãªã©ï¼‰

---

## ç’°å¢ƒå¤‰æ•°

**å¿…é ˆ:**

```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJhbGc...

# Gemini API
GEMINI_API_KEY=AIzaSy...
```

---

## ã¾ã¨ã‚

Embeddingæ¤œç´¢ã«ã‚ˆã‚‹é¡ä¼¼ä½œä¾‹æ¤œç´¢ã®æ¤œè¨¼ç’°å¢ƒãŒå®Œæˆã—ãŸã€‚File Search APIã¨æ¯”è¼ƒã—ã¦**50-180å€ã®é«˜é€ŸåŒ–**ã‚’å®Ÿç¾ã—ã€ç‹¬ç«‹ã—ãŸæ¤œè¨¼ãƒšãƒ¼ã‚¸ï¼ˆ`/test-embedding`ï¼‰ã§ä¸¦è¡Œæ¤œè¨¼ãŒå¯èƒ½ã€‚

**æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:**

1. âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
2. âœ… æ—¢å­˜æŠ•ç¨¿ã®Embeddingç”Ÿæˆï¼ˆ`npx tsx scripts/generate-embeddings-batch.ts`ï¼‰
3. ğŸ”„ 2-3é€±é–“ã®æ¤œè¨¼æœŸé–“é–‹å§‹
4. ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã®åé›†ã¨åˆ†æ
5. âœ… æˆåŠŸæ¡ä»¶ã‚’æº€ãŸã›ã°æœ¬ç•ªé©ç”¨

**æ¤œè¨¼é–‹å§‹æ—¥**: 2025-11-24
**æ¤œè¨¼çµ‚äº†äºˆå®š**: 2025-12-15
**åˆ¤æ–­ä¼šè­°**: 2025-12-16
